\section{Gradual Typing Syntax}

\newcommand{\dynof}[1]{\textrm{dyn}(#1)}
\begin{theorem}
  For every $A$, there is a derivation $\dynof A : A \ltdyn D$
\end{theorem}
\begin{proof}
  By induction on $A$:
  \begin{enumerate}
  \item $A = \dyn$, then $r(\dyn) : \dyn \ltdyn \dyn$
  \item $A = \nat$, then $\inat : \nat \ltdyn \dyn$
  \item $A = A_1 \ra A_2$ then $(\dynof {A_1} \ra \dynof {A_2})\iarr : A_1 \ra A_2 \ltdyn \dyn$ 
  \item $A = A_1 \times A_2$ then $(\dynof {A_1} \times \dynof{A_2})\itimes : A_1 \times A_2 \ltdyn \dyn$ 
  \end{enumerate}
\end{proof}

\begin{theorem}
  For any two derivations $c,c' : A \ltdyn A'$ of the same precision
  $c \equiv c'$
\end{theorem}
\begin{proof}
  \begin{enumerate}
  \item We show this by showing that derivations have a canonical
    form.

    The following presentation of precision derivations has unique derivations
    \begin{mathpar}
      \inferrule{}{\textrm{refl}(D) : D \ltdyn D}\and
      \inferrule{}{\textsf{Inj}_{\text{nat}} : \nat \ltdyn D}\and
      \inferrule{}{\textrm{refl}(\nat) : \nat \ltdyn \nat}\and
      \inferrule{c : A_i \ra A_o \ltdyn D\ra D}{c(\textsf{Inj}_{\text{arr}}) : A_i \ra A_o \ltdyn \nat}\and
      \inferrule{c : A_i \ltdyn A_i' \and d : A_o \ltdyn A_o'}{c \ra d : A_i \ra A_o \ltdyn A_i'\ra A_o'}
      %% \inferrule{A_1 \times A_2 \ltdyn D\times D}{A_1 \times A_2 \ltdyn \nat}
      %% \inferrule{A_1 \ltdyn A_1' \and A_2 \ltdyn A_2'}{A_1 \times A_2 \ltdyn A_1'\times A_2'}
    \end{mathpar}
    Since it satisfies reflexivity, cut-elimination and congruence, it
    is a model of the original theory. Since it is a sub-theory of the
    original theory, it is equivalent.
  \end{enumerate}
\end{proof}

Type precision is a binary relation on typed terms. The original
gradual guarantee rules are as follows:
\begin{mathpar}
  \inferrule
  {\Gamma^\ltdyn \vdash M \ltdyn M' : c \and
    c : A \ltdyn A'\and
    c' : A \ltdyn A_2'
  }
  {\Gamma^\ltdyn \vdash M \ltdyn (M :: A_2') : c'}

  \inferrule
  {\Gamma^\ltdyn \vdash M \ltdyn M' : c \and
    c : A \ltdyn A'\and
    c' : A_2 \ltdyn A'
  }
  {\Gamma^\ltdyn \vdash (M :: A_2) \ltdyn M' : c'}
\end{mathpar}
Where the cast $M :: A_2$ is defined to be
\[ \dnc {dyn(A_2)}{\upc {dyn(A)} M} \]

These two rules are admissible in our presentation.

For the first rule, we first prove that $\dnc {dyn(A_2)}\upc {dyn(A)} M = \dnc {c'}\upc{c} M$
\begin{align*}
  \dnc {dyn(A_2)}\upc {dyn(A)} M
  &= \dnc {(c \dynof {A'})}\upc{(c'\dynof{A'})} M \tag{All derivations are equal}\\
  &= \dnc {c}\dnc {\dynof{A'}}\upc{\dynof{A'}}\upc{c'} M\tag{functoriality}\\
  &= \dnc {c}\upc{c'} M\tag{retraction}\\
\end{align*}

Then the rest follows by the up/dn rules above and the fact that
precision derivations are all equal.

Thus the following properties are sufficient to provide an extensional
model of gradual typing without requiring transitivity of term
precision:
\begin{enumerate}
\item Every precision is representable in the above sense,
\item The association of casts to precision is functorial
\item Type constructors are covariant functorial with respect to
  relational identity and composition
\end{enumerate}

\section{Call-by-push-value}

\subsection{Morphisms of CBPV Models}

\max{there is not definition of a CBPV model...}
There are two relevant notions of \emph{morphism} of CBPV models:
\emph{strict} and \emph{lax}.
% morphisms of CBPV models
Given call-by-push-value models
$\mathcal M_1 = (\mathcal V_1, \mathcal E_1, \arr_1, U_1, F_1)$ and
$\mathcal M_2 = (\mathcal V_2, \mathcal E_2, \arr_2, U_2, F_2)$,
A \emph{strict} morphism $G$ from $M_1$ to $M_2$ is given by a pair of functors
$G_{\mathcal{V}}: V_1 \to V_2$ and $G_{\mathcal{E}} : E_1 \to E_2$
that strictly presere the constructors:
\begin{enumerate}
  \item $G_{\mathcal{E}} \circ F_1 = F_2 \circ G_{\mathcal{V}}$
  \item $G_{\mathcal{V}} \circ U_1 = U_2 \circ G_{\mathcal{E}}$
  \item $G_{\mathcal{E}}(A \arr_1 B) = G_{\mathcal{V}}(A) \arr_2 G_{\mathcal{E}}(B)$
  \item $G_{\mathcal{V}}(A_1 \times_1 A_2) = G_{\mathcal{V}}(A_1) \times_2 G_{\mathcal{V}}(A_2)$
  \item $G_{\mathcal{V}}(1_1) = 1_2$
\end{enumerate}
As well as strictly preserving the corresponding universal morphisms
and coherence isomorphisms.

A lax morphism instead preserves these only up to transformation
\begin{enumerate}
  \item $G_{\mathcal{E}} \circ F_1 \Rightarrow F_2 \circ G_{\mathcal{V}}$
  \item $G_{\mathcal{V}} \circ U_1 \Rightarrow U_2 \circ G_{\mathcal{E}}$
  \item $G_{\mathcal{E}}(A \arr_1 B) \Rightarrow G_{\mathcal{V}}(A) \arr_2 G_{\mathcal{E}}(B)$
  \item $G_{\mathcal{V}}(A_1 \times_1 A_2) \Rightarrow G_{\mathcal{V}}(A_1) \times_2 G_{\mathcal{V}}(A_2)$
  \item $G_{\mathcal{V}}(1_1) \Rightarrow 1_2$
\end{enumerate}
Additionally a lax morphism should have a relationship between these
transformations and the universal morphisms, but we will only consider
lax morphisms of thin categories, where such conditions hold
trivially.

\subsection{Kleisli Actions of CBPV Type Constructors}

In CBPV models, all the type constructors are interpreted as functors:
\begin{enumerate}
\item $\to : \op\calV \times \calE \to \calE$
\item $\times : \calV \times \calV \to \calV$
\item $F : \calV \to \calE$
\item $U : \calE \to \calV$
\end{enumerate}
That is, they all have functorial actions on \emph{pure} morphisms of
value types and \emph{linear} morphisms of computation types.
%
We use these functorial actions extensively in the construction of
casts and their corresponding perturbations. But when defining
downcasts of value types and upcasts of computation types, we
additionally need a second functorial action of these categories:
functoriality in \emph{impure} morphisms of value types and
\emph{non-linear} morphisms of computation types. These notions of
morphism are given by the \emph{Kleisli} categories $\calVk$ and
$\calEk$ which have value types and computation types as objects but
morphisms are defined as
\[ \calVk(A,A') = \calE(F A, FA')\]
\[ \calEk(B,B') = \calV(U B, U B')\]
with composition given by composition in $\calE/\calV$.  That is we
need to define a second functorial action, that agrees with the above
on objects for these Kleisli categories:
\begin{enumerate}
\item $\tok : \op\calVk \square \calEk \to \calEk$
\item $\timesk : \calVk \square \calVk \to \calVk$
\item $\Fk : \calVk \to \calEk$
\item $\Uk : \calEk \to \calVk$
\end{enumerate}
Note that rather than the product of categories we use the ``funny
tensor product'' $\square$. This is because the action on
impure/non-linear morphisms for $\tok/\timesk$ do not satisfy ``joint
functoriality'' but instead only ``separate functoriality'', meaning
we give rather than an action on morphisms in both categories
simultaneously instead an action on each argument categories morphisms
with the object in the other category fixed. The existence of these
functorial actions for $\tok$ and $\timesk$ is reliant on the
\emph{strength} of the adjunction. We describe them using the internal
language of CBPV in order to more easily verify their
existence/functoriality:
\begin{enumerate}
\item For $\tok$ we define for $\phi : \calE(F A,F A')$ and $B \in \calE$ the morphism $\phi \tok B : \calV(U(A' \to B),U(A\to B))$ as
  \[ t:U(A'\to B) \vdash \phi \tok B = \{ \lambda x. x' \leftarrow \phi\,[\ret x]; ! t x'\} : U(A \to B) \]
  and for $A \in \calV$ and $f : \calV(UB,UB')$ we define $A \tok f : \calV(U(A \to B),U(A\to B'))$ as
  \[ t : U(A \to B) \vdash A \tok f = \{ \lambda x. !f[\{ ! t x \}]\} \]
\item For $\timesk$ we define for $\phi : \calE(F A_1,FA_2)$ and $A' \in \calV$ the morphism $\phi \timesk A_2$ as
  \[ \bullet : F(A_1\times A_2) \vdash \phi \timesk A_2 = (x_1,x_2) \leftarrow \bullet; x_1' \leftarrow \phi[\ret x_1]; \ret (x_1',x_2) : F(A_1'\times A_2)\]
  and $A_1 \timesk \phi$ is defined symmetrically.
\item For $\Uk$ we need to define for $f : \calV(UB,UB')$ a morphism $\Uk f : \calE(FUB,FUB')$. This is simply given by the functorial action of $F$: $\Uk f = F(f)$
\item Similarly $\Fk \phi = U\phi$
\end{enumerate}

Functoriality in each argument is easily established, meaning for
example for the function type is functorial in each argument:
\begin{enumerate}
\item $(\phi \circ \phi') \tok B = (\phi' \tok B) \circ (\phi \tok B)$
\item $\id \tok B = \id$
\item $A \tok (f \circ f') = (A \tok f) \circ (A \tok f)$
\item $A \tok \id = \id$
\end{enumerate}

Finally, note that all of these constructions lift to squares in a
double CBPV model since the squares themselves form a CBPV model and
the projection functions preserve CBPV structure. For instance, given a square
$\alpha : \phi \ltdyn_{F c_o}^{F c_i} \phi'$ and a horizontal morphism $d : B \rel B'$ of appropriate type, we get a square
\[ \alpha \tok d : \phi \tok B \ltdyn_{U(c_o \to d)}^{U(c_i \to d)} \phi' \tok B' \]

\section{Omitted Proofs Section \ref{sec:towards-relational-model}}

\begin{theorem}
  Let $R$ be a binary relation on the free error domain $U(\li A)$. If
  $R$ satisfies the following properties
  \begin{enumerate}
  \item Transitivity
  \item $\theta$-congruence: If $\later_t (\tilde{x}_t \binrel{R} \tilde{y}_t)$, then $\theta(\tilde{x}) \binrel{R} \theta(\tilde{y})$.
  \item Right step-insensitivity: If $x \binrel{R} y$ then $x \binrel{R} \delta y$.
  \end{enumerate}
  Then for any $l : U(\li A)$, we have $l \binrel{R} \Omega$. If $R$ is left
  step-insensitive instead then $\Omega \binrel{R} x$.
\end{theorem}
\begin{proof}
  By \lob-induction: we assume that $\laterhs (l \binrel{R} \Omega)$, and we
  show $(l \binrel{R} \Omega)$. We have $l \binrel{R} \delta l$ by right
  step-insensitivity.
  %
  By transitivity, it will therefore suffice to show that $\delta l \binrel{R}
  \Omega$.
  %
  Then since $\Omega = \delta \Omega$, it suffices to show $\delta l \binrel{R}
  \delta\Omega$.
  %
  By $\theta$-congruence, it suffices to show that
  $\later_t [(\nxt\, l)_t \binrel{R} (\nxt\, \Omega)_t]$, i.e., $\later (l \binrel{R} \Omega)$,
  which is our induction hypothesis.

  The proof when $R$ is left step-insensitive is symmetric.
\end{proof}

\section{Details of the Relational Model Construction}

In Section \ref{sec:concrete-relational-model} we described our model of gradual
typing. We omitted several technical proofs involving the well-definedness of
composition of relations and the actions of functors. We provide those proofs in
this section.

% We note that our approach in this section will be differ from the body of the
% paper in two ways: 

% First, we will work \emph{abstractly} with a notion of model of gradual typing
% defined in the setting of an arbitrary double category.
% %
% Second, we build up the abstract notion of model in several phases, and layer
% the constructions in a modular way so that we can isolate the essential parts of
% the proofs and abstract away unnecessary details about previous parts of the
% construction.

% The constructions we carry out in this section specialize to the model we
% describe in the body of the paper. We find, however, that organizing things in
% this manner makes the arguments easier to follow.


\subsection{Free Composition of Error Domain Relations}
\begin{definition}\label{def:free-comp-ed-rel}
  Let $d : B_1 \rel B_2$ and $d' : B_2 \rel B_3$ be error domain relations. We
  define the composition $dd'$ inductively by the following rules:
  \begin{mathpar}
      \inferrule*[right = Comp]
      {b_1 \mathbin{d} b_2 \and b_2 \mathbin{d'} b_3}
      {b_1 \mathbin{d \relcomp d'} b_3}

      \inferrule*[right = DnClosed]
      {b_1' \le_{B_1} b_1 \and b_1 \mathbin{d \relcomp d'} b_3}
      {b_1' \mathbin{d \relcomp d'} b_3}

      \inferrule*[right = UpClosed]
      {b_1 \mathbin{d \relcomp d'} b_3 \and b_3 \le_{B_3} b_3'}
      {b_1 \mathbin{d \relcomp d'} b_3'}

      \inferrule*[right = PresErr]
      { }
      {\mho_{B_1} \mathbin{d \relcomp d'} b_3}

      \inferrule*[right = PresTheta]
      {\later_t( \tilde{b_1} \mathbin{d \relcomp d'} \tilde{b_3} ) }
      {\theta_{B_1}(\tilde{b_1}) \mathbin{d \relcomp d'} \theta_{B_3}(\tilde{b_3}) }
  \end{mathpar}
\end{definition}

\subsection{The Dynamic Type}
The ordering $\le_D$ on the predomain $D$ is defined by
\begin{align*}
  \inat(n) \le \inat(n') 
      &\iff n = n' \\
  \itimes (d_1, d_2) \le \itimes (d_1', d_2')
      &\iff d_1 \le_D d_2 \text{ and } d_1' \le_D d_2'\\
  \iarr(\tilde{f}) \le \iarr(\tilde{f'}) 
      &\iff \later_t(\tilde{f}_t \le \tilde{f'}_t),
\end{align*}

and the bisimilarity relation is analogous.


\subsection{Lemmas about Perturbations}

The goal of this section is to prove the following lemmas:

%%%%%%%%%%%%%%%
% Composition %
%%%%%%%%%%%%%%%
\begin{lemma}\label{lem:push-pull-comp}
  Let $(A_1, M_{A_1}, i_{A_1})$, $(A_2, M_{A_2}, i_{A_2})$, and $(A_3, M_{A_3},
  i_{A_3})$ be value objects, and let $c : A_1 \rel A_2$ and $c' : A_2 \rel A_3$
  be predomain relations.

  Given a push-pull structure $\Pi_c$ for $c$ and $\Pi_{c'}$ for $c'$, we can
  define a push-pull structure $\Pi_{c \comp c'}$ for $c \comp c'$.

  Likewise, we can define a push-pull structure for the composition of error
  domain relations.
\end{lemma}
\begin{proof}
  We define $\piv_{c \comp c'}$ as follows: We first define
  %
  $\push_{c \comp c'} = \push_{c'} \circ \push_{c}$ and 
  $\pull_{c \comp c'} = \pull_{c} \circ \pull_{c'}$.
  %
  We then observe that the required squares exist for both push and pull. In
  particular, for push we have that $i_{A_1}(m_{A_1}) \ltdyn_c^c
  i_{A_2}(\push_c(m_{A_1}))$ using the push property for $c$, and then using the
  push property for $c'$ we have $i_{A_2}(\push_c(m_{A_1})) \ltdyn_{c'}^{c'}
  i_{A_3}(\push_{c'}(\push_c(m_{A_1})))$. We can then compose these squares
  horizontally to obtain the desired square. The pull property follows
  similarly.

  The push-pull structure for the composition of computation relations is
  defined analogously.
\end{proof}


%%%%%%%%%%%
% U and F %
%%%%%%%%%%%
\begin{lemma}\label{lem:push-pull-U-F} 
  
  Let $A$ and $A'$ be value objects and let $c : A \rel A'$ be a relation on the
  underlying predomains. Given a push-pull structure $\Pi_c$ for $c$ we can
  define a push-pull structure $\Pi_{\li c}$ for $\li c$ with respect to $\li A$
  and $\li A'$.

  Likewise, let $B$ and $B'$ be computation objects and let $d : B \rel B'$ be
  an error domain relation. Given a push-pull structure for $d$ with respect to
  $B$ and $B'$, we can define a push-pull structure for $Ud$ with respect to
  $UB$ and $UB'$.
\end{lemma}
\begin{proof}
  
  We define $\push_{\li c} : \mathbb{N} \oplus M_{A} \to \mathbb{N} \oplus
  M_{A'}$ by the universal property of the coproduct of monoids. In particular,
  it suffices to define a homomorphism of monoids $\mathbb{N} \to \mathbb{N}
  \oplus M_{A'}$ and $M_{A} \to \mathbb{N} \oplus M_{A'}$.

  The former is simply $\inl$ and the latter is $\inr \circ \push_c$.
  
  Then to establish the push property, it suffices by the universal property of
  the coproduct, and the fact that $\mathbb{N}$ is the free monoid on one
  generator, to show that the following two squares exist:

% https://q.uiver.app/#q=WzAsNCxbMCwwLCJcXGxpIEEiXSxbMSwwLCJcXGxpIEEnIl0sWzAsMSwiXFxsaSBBIl0sWzEsMSwiXFxsaSBBJyJdLFswLDEsIlxcbGkgYyIsMCx7InN0eWxlIjp7ImJvZHkiOnsibmFtZSI6ImJhcnJlZCJ9LCJoZWFkIjp7Im5hbWUiOiJub25lIn19fV0sWzIsMywiXFxsaSBjIiwyLHsic3R5bGUiOnsiYm9keSI6eyJuYW1lIjoiYmFycmVkIn0sImhlYWQiOnsibmFtZSI6Im5vbmUifX19XSxbMCwyLCJcXGRlbHRhXipfQSIsMl0sWzEsMywiXFxkZWx0YV4qX3tBJ30iXV0=
\[\begin{tikzcd}[ampersand replacement=\&]
	{\li A} \& {\li A'} \\
	{\li A} \& {\li A'}
	\arrow["{\li c}", "\shortmid"{marking}, no head, from=1-1, to=1-2]
	\arrow["{\delta^*_A}"', from=1-1, to=2-1]
	\arrow["{\delta^*_{A'}}", from=1-2, to=2-2]
	\arrow["{\li c}"', "\shortmid"{marking}, no head, from=2-1, to=2-2]
\end{tikzcd}\]

% https://q.uiver.app/#q=WzAsNCxbMCwwLCJcXGxpIEEiXSxbMCwxLCJcXGxpIEEiXSxbMSwwLCJcXGxpIEEnIl0sWzEsMSwiXFxsaSBBJyJdLFswLDIsIlxcbGkgYyIsMCx7InN0eWxlIjp7ImJvZHkiOnsibmFtZSI6ImJhcnJlZCJ9LCJoZWFkIjp7Im5hbWUiOiJub25lIn19fV0sWzEsMywiXFxsaSBjIiwyLHsic3R5bGUiOnsiYm9keSI6eyJuYW1lIjoiYmFycmVkIn0sImhlYWQiOnsibmFtZSI6Im5vbmUifX19XSxbMCwxLCJcXGxpKGlfQShtX0EpKSIsMl0sWzIsMywiXFxsaSAoaV97QSd9KFxccHVzaF9jKG1fQSkpKSJdXQ==
\[\begin{tikzcd}[ampersand replacement=\&]
	{\li A} \& {\li A'} \\
	{\li A} \& {\li A'}
	\arrow["{\li c}", "\shortmid"{marking}, no head, from=1-1, to=1-2]
	\arrow["{\li(i_A(m_A))}"', from=1-1, to=2-1]
	\arrow["{\li (i_{A'}(\push_c(m_A)))}", from=1-2, to=2-2]
	\arrow["{\li c}"', "\shortmid"{marking}, no head, from=2-1, to=2-2]
\end{tikzcd}\]

where $\delta* = (\delta \circ \eta)^\dagger$

The first square exists by the fact that the monadic extension operation
$-^\dagger$ is monotone in its argument, and the fact that there is a
square $\delta_A \circ \eta_A \ltsq{}{} \delta_{A'} \circ \eta_{A'}$.

The second square exists by the push property for $c$ and the fact that $\li$
acts on squares.

The proof for the pull property is dual, and the construction of a push-pull
structure for $Ud$ is analogous.
\end{proof}


%%%%%%%%%%%%
% Products %
%%%%%%%%%%%%
\begin{lemma}\label{lem:push-pull-times} Let $A_1$, $A_1'$, $A_2$, and $A_2'$ be
  value objects. Let $c_1 : A_1 \rel A_1'$ and $c_2 : A_2 \rel A_2'$ be
  relations on the underlying predomains. Given push-pull structures $\Pi_{c_1}$
  for $c_1$ and $\Pi_{c_2}$ for $c_2$ we can define a push-pull structure
  $\Pi_{c_1 \times c_2}$ for $c_1 \times c_2$.
\end{lemma}
\begin{proof}
Recall that the monoid of syntactic perturbations for $A_1 \times A_2$ is
$M_{A_1} \oplus M_{A_2}$ and the monoid for $A_1' \times A_2'$ is $M_{A_1'}
\oplus M_{A_2'}$. Thus to define the push homomorphism for $c_1 \times c_2$, it
suffices by the universal property of the coproduct of monoids to define a
homomorphism $M_{A_1} \to M_{A_1'} \oplus M_{A_2'}$ and $M_{A_2} \to M_{A_1'}
\oplus M_{A_2'}$. The former is $\inl \circ \push_{c_1}$, and the latter is
$\inr \circ \push_{c_2}$. The pull homomorphism is defined similarly.

For the push property, we need to show that there is a square 
$i_{A_1 \times A_2}(m_1) \ltsq{}{} i_{A_1' \times A_2'}(\push_{c_1 \times c_2}(m_1))$.
%
By the universal property of the coproduct, it suffices to consider two cases: a
perturbation $m_1 \in M_{A_1}$ and a perturbation $m_2 \in M_{A_2}$. In the
first case, using the definition of the interpretation homomorphism for the
product, the square becomes $(i_{A_1}(m_1) \times \id_{A_2}) \ltsq{}{}
(i_{A_1'}(\push_{c_1}(m_1)) \times \id_{A_2'})$.
%
Then by the action of $\times$ on squares, it suffices to show that there are
squares $i_{A_1}(m_1) \ltsq{}{} i_{A_1'}(\push_{c_1}(m_1))$ and $\id_{A_2}
\ltsq{}{} \id_{A_2'}$. The former is the push property for $c_1$, and the latter
is an identity square.

The second case, i.e., $m_2 \in M_{A_2}$, is symmetric, and the proof of the
pull property is dual.
\end{proof}

%%%%%%%%%
% Arrow %
%%%%%%%%%
\begin{lemma}\label{lem:push-pull-arrow} Let $A$ and $A'$ be value objects and
  $B$ and $B'$ be computation objects. Let $c : A \rel A'$ be a relation on the
  underlying predomains and $d : B \rel B'$ a relation on the underlying error
  domains. Given push-pull structures $\Pi_c$ for $c$ and $\Pi_d$ for $d$, we
  can define a push-pull structure $\Pi_{c \arr d}$ for $c \arr d$.
\end{lemma}
\begin{proof}
  Similar to the product case above.
\end{proof}


We next define the actions of the Kleisli arrow and product functors on
syntactic perturbations.

% ``Kleisli arrow'' action on syntactic perturbations that takes a
% perturbation in $M_{UB}$ to a perturbation in $M_{U(A \to B)}$, as follows:

\begin{definition}\label{def:kleisli-arrow-perturbations} Let $A$ be a value
  object and $B$ be a computation object. We define a homomorphism of monoids
  $id \tok - \colon M_{UB} \to M_{U(A \arr B)}$ via the universal property of the
  coproduct of monoids by sending $\mathbb{N}$ to the first injection in $M_{U(A
  \arr B)} = \mathbb{N} \oplus M_A^{op} \oplus M_B$, and sending $M_B$ to the
  third injection.

  Likewise, we define $- \tok \id \colon M_{\li A}^{op} \to M_{U(A \arr B)}$ as
  follows. First note that $M_{\li A}^{op} = \mathbb{N} \oplus M_A^{op}$. Then
  we construct the homomorphism via the universal property, sending $\mathbb{N}$
  to the first injection $M_A^{op}$ to the second injection.
\end{definition}

We can similarly construct a Kleisli product operation on perturbations:

\begin{definition}\label{def:kleisli-product-perturbations}
  Let $A_1$ and $A_2$ be value objects. We define a homomorphism of monoids 
  $- \timesk \id \colon M_{\li A_1} \to M_{\li (A_1 \times A_2)}$ using the universal property,
  sending $\mathbb{N}$ to the first injection and $M_{A_1}$ to the second injection.

  Likewise, we define $\id \timesk - \colon M_{\li A_2} \to M_{\li (A_1 \times A_2)}$
  by sending $\mathbb{N}$ to the first injection and $M_{A_2}$ to the third injection.

  %  Given a perturbation $(n, a_1, a_2) \in $ we define $(n, a_1, a_2)
  % \timesk \id = (n, a_1, \id_{P_{A_2}})$, and likewise we define $\id \timesk (n,
  % a_1, a_2) = (n, \id_{P_{A_1}}, a_2)$.
\end{definition}

It is then easy to verify that the Kleisli arrow action on perturbation is well-defined 
in that for any $m \in M_{UB}$, we have
%
\[ \ptb_{U(A \arr B)}(\id \tok m) = \id \tok i_{UB}(m), \]
%
where the LHS is the Kleisli action on perturbation and the RHS is the Kleisli
action on morphisms. 
%
The proof uses the fact that the morphism $\delta$ commutes with all error
domain morphisms, which is a consequence of the definition of error domain
morphism.
%
The other verification involving the Kleisli arrow action is similar, as are the
two Kleisli product actions.

% %
% \[ (\delta_{U(A \arr B)}^*)^n \circ U(\id_{A} \arr \i_B(b)) = 
%     \id \tok (\delta_{UB}^*)^n \circ U(\ptb_B(b)) \]
% %
% This can be checked by unfolding the definition of $\tok$; the proof uses the
% fact that $\delta_{UB}^*$ commutes with computation morphisms.
% %

% Given a perturbation $q = (n, a) \in P_{FA}$ we define $(n, a) \tok \id = (n, a,
% \id_{P_B}) \in P_{U(A \to B)}$. We need to show that
% %
% \[ \ptb_{U(A \arr B)}((n, a) \tok \id) = \ptb_{FA}(n, a) \tok \id. \]
% %
% By similar reasoning to the above, this holds because $\delta_{FA}^*$ commutes
% with computation morphisms.



% We have $\ptb_{U(A \arr B)}(\id \tok (n, b)) = \ptb_{U(A \arr B)}(n, \id, b)$, 
% which is equal to $\delta_{U(A \arr B)}^n (\id \to \ptb_B(b))$


% %%%%%%%%%%%%%%%%%%%%%%
% % Model Construction %
% %%%%%%%%%%%%%%%%%%%%%%
% We now proceed with the construction of the model:

%     Define a step-2 model $\mathcal M'$ as follows:
%     \begin{itemize}
%       \item Value objects are pairs consisting of:
%       \begin{itemize}
%         \item A value object $A$ in $\vf$.
%         \item A monoid $P_A$ of perturbations
%         and a monoid homomorphism $\ptb_A : P_A \to \{ f \in \vf(A, A) \mid f \bisim \id_A \}$.
       
%       \end{itemize}  

%       \item Computation objects are pairs consisting of:
%       \begin{itemize}
%         \item A computation object $B$ in $\ef$.
%         \item A monoid $P_B$ of perturbations and a monoid homomorphism
%         $\ptb_B : P_B \to \{ \phi \in \ef(B, B) \mid \phi \bisim \id_B \}$.
%       \end{itemize}

%       \item Morphisms are given by morphisms of the underlying objects in $\vf$ and $\ef$, respectively.
%       %, i.e.,
%       % \[ \vf'((A, P_A, \ptb_A, P^K_A, \ptbk_A), (A', P_{A'}, \ptb_{A'}, P^K_{A'}, \ptbk_{A'})) = \vf(A, A') \]
%       %
%       % and likewise for computations.

%       \item Given objects $(A, P_A, \ptb_A)$ and $(A', P_{A'}, \ptb_{A'})$ a value relation
%       is a pair consisting of
%       \begin{itemize}
%         \item A value relation $c \in \vsq$.
%         \item A push-pull structure $\piv_c$ for $c$ with respect to $P_A$ and $P_{A'}$.
%         %\item A push-pull structure $\pie_{Fc}$ for $Fc$ with respect to $P^K_A$ and $P^K_{A'}$.
%       \end{itemize}

%       \item Similarly, a computation relation between $(B, P_B, \ptb_B)$ and $(B', P_{B'}, \ptb_{B'})$
%       consists of
%       \begin{itemize}
%         \item A computation relation $d \in \esq$.
%         \item A push-pull structure $\pie_d$ for $d$ with respect to $P_B$ and $P_{B'}$.
%         %\item A push-pull structure $\piv_{Ud}$ for $Ud$ with respect to $P^K_B$ and $P^K_{B'}$.
%       \end{itemize}
            
%       \item The squares are the same as the squares of the original model $\mathcal M$
%       %morphisms of $\vsq'$ and $\esq'$ are given by the morphisms of $\vsq$ and $\esq$.
      
%       \item We define composition of relations $(c, \piv_c)$ and $(c', \piv_{c'})$
%       as $(c \comp c', \piv_{c \comp c'})$ where $\piv_{c \comp c'}$ is as in Lemma
%       \ref{lem:push-pull-comp}, and likewise for computation relations.

%     \end{itemize}
      
%       % Functors \times, +, F, U, arrow
%       Now we define the actions of the functors:
%       \begin{itemize}

%       \item We define $\times$ on objects by
      
%       \[ (A_1, P_{A_1}, \ptb_{A_1}) \times (A_2, P_{A_2}, \ptb_{A_2}) =
%         (A_1 \times A_2, P_{A_1} \times P_{A_2}, \ptb_{A_1 \times A_2}) \]

%       where $\ptb_{A_1 \times A_2}(p_1, p_2) = \ptb_{A_1}(p_1) \times \ptb_{A_2}(p_2)$.

%       Using Lemma \ref{lem:push-pull-times}, we define $\times$ on relations by

%       \[ (c_1, \piv_{c_1}), (c_2 \piv_{c_2}) = 
%         (c_1 \times c_2, \piv_{c_1 \times c_2}). \]

%       \item We define $F$ on objects by 
      
%       \[ F(A, P_A, \ptb_A) = (FA, \mathbb{N} \times P_A, \ptb_{FA}), \]

%       where we define $\ptb_{FA}(n, a) = (\delta_{FA}^*)^n \circ F(\ptb_A(a))$.

%       Using Lemma \ref{lem:push-pull-U-F}, we define $F$ on relations by

%       \[ F(c, \piv_c) = (Fc, \pie_{Fc}). \]

%       \item We define $U$ on objects by
       
%       \[ U(B, P_B, \ptb_B) = (UB, \mathbb{N} \times P_B, \ptb_{UB}), \]

%       where we define $\ptb_{UB}(n, b) = (\delta_{UB}^*)^n \circ U(\ptb_B(b))$.

%       Using Lemma \ref{lem:push-pull-U-F}, we define $U$ on relations by

%       \[ U(d, \pie_d) = (Ud, \piv_{Ud}).  \]

%       We define $\arr$ on objects by

%       \[ (A, P_A, \ptb_A) \arr (B, P_B, \ptb_B) = 
%         (A \arr B, P_A^{op} \times P_B, \ptb_{A \arr B}), \]

%       where we define $\ptb_{A \arr B}(a, b) = \ptb_A(a) \arr \ptb_B(b)$.

%       Using Lemma \ref{lem:push-pull-arrow}, we define $\arr$ on relations by

%       \[ (c, \piv_c) \arr (d, \pie_d) =
%         (c \arr d, \pie_{c \arr d}). \]

%     \end{itemize}


    


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsection{Lemmas involving Quasi-Representable Relations}

In this section we prove lemmas about quasi-representability needed for showing
that our notions of value and computation relation are compositional, and for
defining the action of the functors $U$, $\li$, $\arr$, and $\times$ on value
and computation relations.

Recall the notion of quasi-order-equivalence as defined in Definition
\ref{def:quasi-order-equivalent}. The following lemma will be useful in showing
that two relations are quasi-order-equivalent.

\begin{lemma}\label{lem:left-rep-by-same-morphism} Let $A$ and $A'$ be value
  objects, and let $c, c' : A \rel A'$ be relations between the underlying
  predomains. If $c$ and $c'$ are both quasi-left-representable by the same
  predomain morphism $f : A \to A'$, then $c \qordeq c'$. If $c$ and $c'$ are
  both quasi-right-representable by the same predomain morphism $g : A' \to A$
  then $c \qordeq c'$.

  Dually, let $B$ and $B'$ be computation objects, and let $d, d' : B \rel B'$
  be relations between the underlying error domains. If $d$ and $d'$ are both
  quasi-right-representable by the same error domain morphism $\phi : B'
  \multimap B$, then $d \qordeq d'$. If $d$ and $d'$ are both
  quasi-left-representable by the same $\phi : B \multimap B'$
\end{lemma}
\begin{proof}
  We show the result for $c$ and $c'$ that are quasi-left-representable by the same $f$;
  the other proofs are analogous. 

  By $\upr$ for $c'$, there exists a perturbation $\delle_{c'}$ and a square
  $\upr_{c'} : \delle_{c'} \ltdyn_{c'}^{r(A)} f$.

  By $\upl$ for $c$, there exists a perturbation $\delre_c$ and a square 
  $\upl_c : f \ltdyn_{r(A')}^{c} \delre_c$.
  
  Composing these horizontally we get the following square:

  % https://q.uiver.app/#q=WzAsNixbMCwwLCJBIl0sWzEsMCwiQSJdLFsyLDAsIkEnIl0sWzAsMSwiQSJdLFsxLDEsIkEnIl0sWzIsMSwiQSciXSxbMCwxLCJyKEEpIl0sWzEsMiwiYyJdLFszLDQsImMnIiwyXSxbNCw1LCJyKEEnKSIsMl0sWzAsMywiaV9BKFxcZGVsbGVfe2MnfSkiLDJdLFsxLDQsImYiLDJdLFsyLDUsImlfe0EnfShcXGRlbHJlX2MpIl1d
  \[\begin{tikzcd}[ampersand replacement=\&]
    A \& A \& {A'} \\
    A \& {A'} \& {A'}
    \arrow["{r(A)}", from=1-1, to=1-2]
    \arrow["{i_A(\delle_{c'})}"', from=1-1, to=2-1]
    \arrow["c", from=1-2, to=1-3]
    \arrow["f"', from=1-2, to=2-2]
    \arrow["{i_{A'}(\delre_c)}", from=1-3, to=2-3]
    \arrow["{c'}"', from=2-1, to=2-2]
    \arrow["{r(A')}"', from=2-2, to=2-3]
  \end{tikzcd}\]

  Then since $r(A) \comp c = c$ and $c' \comp r(A') = c'$, we obtain the desired square.
  %
  The other square (i.e., with $c'$ on top) is constructed in an analogous
  manner.

\end{proof}


Next we show that the functors $\li$ and $U$ preserve quasi-representability.

%%%%%%%%%%%%%
% U and F
%%%%%%%%%%%%%
\begin{lemma}\label{lem:representation-U-F}
  Let $A$ and $A'$ be value objects and let $c : A \rel A'$ be a predomain relation.
  If $c$ is quasi-left-representable, then $\li c$ is quasi-left-representable.
  Likewise, if $c$ is quasi-right-representable, then $\li c$ is quasi-right-representable.

  %Then we can define a left-representation structure $\rho^L_{UF(c)}$ for $UF(c)$.

  Similarly, let $B$ and $B'$ be computation objects and let $d : B \rel B'$ be an error domain relation.
  If $d$ is quasi-right-representable, then $Ud$ is quasi-right-representable.

  % Then we can define a right-representation structure $\rho^R_{FU(d)}$ for $FU(d)$.
\end{lemma}
\begin{proof}
  To show that $\li c$ is quasi-left-representable, we define
  \begin{itemize}
    \item $e_{\li c} = \li e_c$
    \item $\delre_{\li c} = \inr (\delre_c)$ 
    (recalling that the monoid $M_{\li A'} = \mathbb{N} \oplus M_{A'}$)
    \item $\delle_{\li c} = \inr (\delle_c)$
  \end{itemize}
  We obtain the two squares $\upl$ and $\upr$ using the definition of the
  interpretation of syntactic perturbations for $\li$ and the functorial action
  of $\li$ on the corresponding squares for $c$.

  The proof for $Ud$ is analogous.
\end{proof}


Next we show that the identity relation is quasi-representable.

%%%%%%%%%%%%
% Identity %
%%%%%%%%%%%%

\eric{Identity relation is quasi-representable}


%%%%%%%%%%%%%%%
% Composition %
%%%%%%%%%%%%%%%

We begin by showing that the composition of quasi-representable relations with
push-pull structures is quasi-representable.

\begin{lemma}\label{lem:representation-comp}
  Let $A$, $A'$, and $A''$ be value objects, and $B$, $B'$, and
  $B''$ be computation objects. Let $c : A \rel A'$ and $c' : A' \rel A''$ be
  predomain relations with push-pull structures, and let $d : B \rel B'$ and $d'
  : B' \rel B''$ be error domain relations with push-pull structures.
  \begin{enumerate}
    \item If $c$ and $c'$ are quasi-left- (resp. right)-representable, then $c
    \comp c'$ is quasi-left- (resp. right)-representable.

    \item If $d$ and $d'$ are quasi-left- (resp. right)-representable, then
    $d \comp d'$ is quasi-left (resp. right)-representable.
  \end{enumerate}
\end{lemma}
\begin{proof}
    % 1.
    \item To show $c \comp c'$ is quasi-left-representable we define
    \begin{itemize}
      \item $e_{c \comp c'} = e_{c'} \circ e_c$
      \item $\delre_{c \comp c'} = \delre_{c'} \cdot \push_{c'}(\delre_c)$ where
      $\cdot$ denotes multiplication in the monoid $M_A$
      \item $\delle_{c \comp c'} = \pull_c(\delle_{c'}) \cdot \delle_c$
      \item $\upl$ is the following square: \input{squares/UpL-comp}

      The square $(*)$ exists by the push-pull property for $c'$, and the square
      $(**)$ exists by the downward closure of $c'$.

      \item $\upr$ is the following square: \input{squares/UpR-comp}
    \end{itemize}

    To show $c \comp c'$ is quasi-right-representable we define
    \begin{itemize}
      \item $p_{c \comp c'} = p_c \circ p_{c'}$
      \item $\dellp_{c \comp c'} = \dellp_c \cdot \pull_c(\dellp_{c'})$
      \item $\delrp_{c \comp c'} = \push_{c'}(\delrp_c) \cdot \delrp_{c'}$
      \item $\dnr$ is the following square: \input{squares/DnR-comp}
      
      Here the square $(*)$ exists by the push-pull property for $c$.
      
      \item $\dnl$ is the following square: \input{squares/DnL-comp}
    \end{itemize}

    % 2.
    \item Same as (1), replacing predomains/morphisms/relations/squares with error domains.
\end{proof}


The next two lemmas concern quasi-order-equivalence and the functors $\li$ and
$U$.

\begin{lemma}\label{lem:Fcc-equiv-FcFc'}
  
  Let $A$, $A'$, and $A''$ be value objects and let $c : A \rel A'$ and $c' : A'
  \rel A''$ be predomain relations. Then we have $\li(c \comp c') \bisim \li c \comp \li c'$ 
  
\end{lemma}
\begin{proof}
  First, we claim that $\li(c \comp c')$ and $\li c \comp \li c'$ are both
  quasi-left-represented by $\li e_{c'} \circ \li e_c$. Indeed, we have by part
  (1) of Lemma \ref{lem:representation-comp} that $e_c' \circ e_c$
  quasi-left-represents $c \comp c'$, and then by Lemma
  \ref{lem:representation-U-F} we have $F(e_c' \circ e_c) = Fe_{c'} \circ Fe_c$
  quasi-left-represents $F(c \comp c')$.
  %
  On the other hand, we also know that $Fe_c$ quasi-left-represents $Fc$ and
  $Fe_{c'}$ quasi-left-represents $Fc'$ again by Lemma
  \ref{lem:representation-U-F}. Then by part (2) of Lemma
  \ref{lem:representation-comp}, their composition quasi-left-represents $Fc
  \comp Fc'$.

  The result now follows by Lemma \ref{lem:left-rep-by-same-morphism}.
\end{proof}

\begin{lemma}\label{lem:Udd-equiv-UdUd'}
  Let $B$, $B'$, and $B''$ be value objects and let $d : B \rel B'$ and $d' : B'
  \rel B''$ be error domain relations. Then we have $U(d \comp d') \bisim Ud \comp Ud'$.
\end{lemma}
\begin{proof}
  Analogous to the proof of the previous lemma.
\end{proof}

Now we combine the above lemmas to show a result about the functors $\li$ and
$U$ applied to a composition of relations:

\begin{lemma}\label{lem:representation-comp-F-U}
  Let $A$, $A'$, and $A''$ be value objects, and $B$, $B'$, and
  $B''$ be computation objects. Let $c : A \rel A'$ and $c' : A' \rel A''$ be
  predomain relations with push-pull structures, and let $d : B \rel B'$ and $d'
  : B' \rel B''$ be error domain relations with push-pull structures.
  \begin{enumerate}
    \item If $\li c$ and $\li c'$ are quasi-right-representable, then $\li (c
    \comp c')$ is quasi-right-representable.
    
    \item If $Ud$ and $Ud'$ are quasi-left-representable, then $U(d \comp d')$
    is quasi-left-representable.

    % \item Given left-representation structures $\rho^L_c$ for $c$ and $\rho^L_{c'}$ for $c'$,
    % we can define a left-representation structure for the composition $c \comp c'$
    % \item Given right-representation structures $\rho^R_d$ for $d$ and $\rho^R_{d'}$ for $d'$,
    % we can define a right-representation structure for the composition $d \comp d'$
    % \item Given right-representation structures $\rho^R_{Fc}$ for $Fc$ and $\rho^R_{Fc'}$ for $Fc'$,
    % we can define a right-representation structure $\rho^R_{F(c \comp c')}$ for $F(c \comp c')$.
    % \item Given left-representation structures $\rho^L_{Ud}$ for $Ud$ and $\rho^L_{Ud'}$ for $Ud'$,
    % we can define a left-representation structure $\rho^L_{U(d \comp d')}$ for $U(d \comp d')$.
  \end{enumerate}
  
\end{lemma}
\begin{proof}
  \begin{enumerate}
    % 1.
    \item We show that $\li (c \comp c')$ is quasi-right-representable.
    
    First, by Lemma \ref{lem:Fcc-equiv-FcFc'} there is a square $\alpha$ of the form

    % https://q.uiver.app/#q=WzAsNSxbMCwwLCJcXGxpIEEiXSxbMiwwLCJcXGxpIEEnJyJdLFswLDEsIlxcbGkgQSJdLFsxLDEsIlxcbGkgQSciXSxbMiwxLCJcXGxpIEEnJyJdLFswLDEsIlxcbGkgKGMgXFxjb21wIGMnKSIsMCx7InN0eWxlIjp7ImJvZHkiOnsibmFtZSI6ImJhcnJlZCJ9LCJoZWFkIjp7Im5hbWUiOiJub25lIn19fV0sWzIsMywiXFxsaSBjIiwwLHsic3R5bGUiOnsiYm9keSI6eyJuYW1lIjoiYmFycmVkIn0sImhlYWQiOnsibmFtZSI6Im5vbmUifX19XSxbMyw0LCJcXGxpIGMnIiwwLHsic3R5bGUiOnsiYm9keSI6eyJuYW1lIjoiYmFycmVkIn0sImhlYWQiOnsibmFtZSI6Im5vbmUifX19XSxbMCwyLCJpX0EoXFxkZWx0YV5sKSIsMl0sWzEsNCwiaV97QScnfShcXGRlbHRhXnIpIl0sWzgsOSwiXFxhbHBoYSIsMSx7InNob3J0ZW4iOnsic291cmNlIjoyMCwidGFyZ2V0IjoyMH0sInN0eWxlIjp7ImJvZHkiOnsibmFtZSI6Im5vbmUifSwiaGVhZCI6eyJuYW1lIjoibm9uZSJ9fX1dXQ==
    \[\begin{tikzcd}[ampersand replacement=\&]
      {\li A} \&\& {\li A''} \\
      {\li A} \& {\li A'} \& {\li A''}
      \arrow["{\li (c \comp c')}", "\shortmid"{marking}, no head, from=1-1, to=1-3]
      \arrow[""{name=0, anchor=center, inner sep=0}, "{i_A(\delta^l)}"', from=1-1, to=2-1]
      \arrow[""{name=1, anchor=center, inner sep=0}, "{i_{A''}(\delta^r)}", from=1-3, to=2-3]
      \arrow["{\li c}", "\shortmid"{marking}, no head, from=2-1, to=2-2]
      \arrow["{\li c'}", "\shortmid"{marking}, no head, from=2-2, to=2-3]
      \arrow["\alpha"{description}, draw=none, from=0, to=1]
    \end{tikzcd}\]
    where $\delta^l$ and $\delta^r$ are syntactic perturbations.

    We define the projection $p_{\li (c \comp c')}$ to be $p_{\li c \comp \li c'} \circ i_{A''}(\delta^r)$.
    We define $\dellp_{\li (c \comp c')}$ to be $\dellp_{\li c \comp \li c'} \cdot \delta^l$.

    Then we can build the $\dnr$ square by pasting the square $\alpha$ on top of
    the $\dnr$ square for the composition $\li c \comp \li c'$, as shown below:

    \eric{Need to change F to $\li$}

    % https://q.uiver.app/#q=WzAsNyxbMCwwLCJGQSJdLFsyLDAsIkZBJyciXSxbMCwxLCJGQSJdLFsxLDEsIkZBJyJdLFsyLDEsIkZBJyciXSxbMCwyLCJGQSJdLFsyLDIsIkZBIl0sWzAsMSwiRihjIFxcY29tcCBjJykiLDAseyJzdHlsZSI6eyJib2R5Ijp7Im5hbWUiOiJiYXJyZWQifSwiaGVhZCI6eyJuYW1lIjoibm9uZSJ9fX1dLFsyLDMsIkZjIiwwLHsic3R5bGUiOnsiYm9keSI6eyJuYW1lIjoiYmFycmVkIn0sImhlYWQiOnsibmFtZSI6Im5vbmUifX19XSxbMyw0LCJGYyciLDAseyJzdHlsZSI6eyJib2R5Ijp7Im5hbWUiOiJiYXJyZWQifSwiaGVhZCI6eyJuYW1lIjoibm9uZSJ9fX1dLFs1LDYsInIoRkEpIiwyLHsic3R5bGUiOnsiYm9keSI6eyJuYW1lIjoiYmFycmVkIn0sImhlYWQiOnsibmFtZSI6Im5vbmUifX19XSxbMCwyLCJcXGRlbHRhXmwiLDJdLFsyLDUsIlxcZGVsbHBfe0ZjIFxcY29tcCBGYyd9IiwyXSxbMSw0LCJcXGRlbHRhXnIiXSxbNCw2LCJwX3tGYyBcXGNvbXAgRmMnfSJdLFsxMSwxMywiXFxhbHBoYSIsMyx7InNob3J0ZW4iOnsic291cmNlIjoyMCwidGFyZ2V0IjoyMH0sInN0eWxlIjp7ImJvZHkiOnsibmFtZSI6Im5vbmUifSwiaGVhZCI6eyJuYW1lIjoibm9uZSJ9fX1dLFsxMiwxNCwiXFxkbnJfe0ZjIFxcY29tcCBGYyd9IiwxLHsic2hvcnRlbiI6eyJzb3VyY2UiOjIwLCJ0YXJnZXQiOjIwfSwic3R5bGUiOnsiYm9keSI6eyJuYW1lIjoibm9uZSJ9LCJoZWFkIjp7Im5hbWUiOiJub25lIn19fV1d
    \[\begin{tikzcd}[ampersand replacement=\&]
      FA \&\& {FA''} \\
      FA \& {FA'} \& {FA''} \\
      FA \&\& FA
      \arrow["{F(c \comp c')}", "\shortmid"{marking}, no head, from=1-1, to=1-3]
      \arrow["Fc", "\shortmid"{marking}, no head, from=2-1, to=2-2]
      \arrow["{Fc'}", "\shortmid"{marking}, no head, from=2-2, to=2-3]
      \arrow["{r(FA)}"', "\shortmid"{marking}, no head, from=3-1, to=3-3]
      \arrow[""{name=0, anchor=center, inner sep=0}, "{\delta^l}"', from=1-1, to=2-1]
      \arrow[""{name=1, anchor=center, inner sep=0}, "{\dellp_{Fc \comp Fc'}}"', from=2-1, to=3-1]
      \arrow[""{name=2, anchor=center, inner sep=0}, "{\delta^r}", from=1-3, to=2-3]
      \arrow[""{name=3, anchor=center, inner sep=0}, "{p_{Fc \comp Fc'}}", from=2-3, to=3-3]
      \arrow["\alpha"{marking, allow upside down}, draw=none, from=0, to=2]
      \arrow["{\dnr_{Fc \comp Fc'}}"{description}, draw=none, from=1, to=3]
    \end{tikzcd}\]

    We define $\delrp_{\li (c \comp c')}$ to be $\delrp_{\li c \comp \li c'} \cdot \delta^r$.
    For $\dnl$, we paste the identity square $\delta^r \ltdyn \delta^r$ on top of
    the $\dnl$ square for the composition $\li c \comp \li c'$, and below that we paste
    the square $\id \ltdyn_{\li (c \comp c')}^{\li c \comp \li c'} \id$ which we get from
    the fact that $\li$ is lax.

    % https://q.uiver.app/#q=WzAsOSxbMCwwLCJGQScnIl0sWzIsMCwiRkEnJyJdLFswLDEsIkZBJyciXSxbMiwxLCJGQScnIl0sWzAsMiwiRkEiXSxbMiwyLCJGQScnIl0sWzAsMywiRkEiXSxbMiwzLCJGQScnIl0sWzEsMiwiRkEnIl0sWzAsMSwicihGQScnKSIsMCx7InN0eWxlIjp7ImJvZHkiOnsibmFtZSI6ImJhcnJlZCJ9LCJoZWFkIjp7Im5hbWUiOiJub25lIn19fV0sWzIsMywicihGQScnKSIsMCx7InN0eWxlIjp7ImJvZHkiOnsibmFtZSI6ImJhcnJlZCJ9LCJoZWFkIjp7Im5hbWUiOiJub25lIn19fV0sWzYsNywiRihjIFxcY29tcCBjJykiLDIseyJzdHlsZSI6eyJib2R5Ijp7Im5hbWUiOiJiYXJyZWQifSwiaGVhZCI6eyJuYW1lIjoibm9uZSJ9fX1dLFswLDIsIlxcZGVsdGFeciIsMl0sWzIsNCwicF97RmMgXFxjb21wIEZjJ30iLDJdLFs0LDYsIlxcaWQiLDJdLFsxLDMsIlxcZGVsdGFeciJdLFszLDUsIlxcZGVscnBfe0ZjIFxcY29tcCBGYyd9Il0sWzUsNywiXFxpZCJdLFs0LDgsIkZjIiwwLHsic3R5bGUiOnsiYm9keSI6eyJuYW1lIjoiYmFycmVkIn0sImhlYWQiOnsibmFtZSI6Im5vbmUifX19XSxbOCw1LCJGYyciLDAseyJzdHlsZSI6eyJib2R5Ijp7Im5hbWUiOiJiYXJyZWQifSwiaGVhZCI6eyJuYW1lIjoibm9uZSJ9fX1dLFsxMiwxNSwicihcXGRlbHRhXnIpIiwzLHsic2hvcnRlbiI6eyJzb3VyY2UiOjIwLCJ0YXJnZXQiOjIwfSwic3R5bGUiOnsiYm9keSI6eyJuYW1lIjoibm9uZSJ9LCJoZWFkIjp7Im5hbWUiOiJub25lIn19fV0sWzEzLDE2LCJcXGRubF97RmMgXFxjb21wIEZjJ30iLDEseyJzaG9ydGVuIjp7InNvdXJjZSI6MjAsInRhcmdldCI6MjB9LCJzdHlsZSI6eyJib2R5Ijp7Im5hbWUiOiJub25lIn0sImhlYWQiOnsibmFtZSI6Im5vbmUifX19XV0=
    \[\begin{tikzcd}[ampersand replacement=\&]
      {FA''} \&\& {FA''} \\
      {FA''} \&\& {FA''} \\
      FA \& {FA'} \& {FA''} \\
      FA \&\& {FA''}
      \arrow["{r(FA'')}", "\shortmid"{marking}, no head, from=1-1, to=1-3]
      \arrow["{r(FA'')}", "\shortmid"{marking}, no head, from=2-1, to=2-3]
      \arrow["{F(c \comp c')}"', "\shortmid"{marking}, no head, from=4-1, to=4-3]
      \arrow[""{name=0, anchor=center, inner sep=0}, "{\delta^r}"', from=1-1, to=2-1]
      \arrow[""{name=1, anchor=center, inner sep=0}, "{p_{Fc \comp Fc'}}"', from=2-1, to=3-1]
      \arrow["\id"', from=3-1, to=4-1]
      \arrow[""{name=2, anchor=center, inner sep=0}, "{\delta^r}", from=1-3, to=2-3]
      \arrow[""{name=3, anchor=center, inner sep=0}, "{\delrp_{Fc \comp Fc'}}", from=2-3, to=3-3]
      \arrow["\id", from=3-3, to=4-3]
      \arrow["Fc", "\shortmid"{marking}, no head, from=3-1, to=3-2]
      \arrow["{Fc'}", "\shortmid"{marking}, no head, from=3-2, to=3-3]
      \arrow["{r(\delta^r)}"{marking, allow upside down}, draw=none, from=0, to=2]
      \arrow["{\dnl_{Fc \comp Fc'}}"{description}, draw=none, from=1, to=3]
    \end{tikzcd}\]


    % 2.
    \item The proof that $U(d \comp d')$ is quasi-left-representable is analogous.

  \end{enumerate}
\end{proof}

% Want to show: U(d \comp d') is weakly equivalent to U(d) \comp U(d').
% This holds because both are quasi-representable by the same projection
% \begin{lemma}
%   Let $\mathcal M$ be a step-3 intensional model, and let
%   $d : B \rel B'$ and $d' : B' \rel B''$.
%   Let $\rho_\text{comp}$ be an arbitrary right-representation for $d \comp d'$.
%   Then the projection $p_{d \circ d'}$ is weakly equivalent to
% \end{lemma}




%%%%%%%%%%%%
% Products %
%%%%%%%%%%%%
\begin{lemma}\label{lem:representation-product} 
  
  Let $c_1 : A_1 \rel A_1'$ and $c_2 : A_2 \rel A_2'$. If $c_1$ and $c_2$ are
  quasi-left-representable, then $c_1 \times c_2$ is quasi-left-representable.
  Furthermore, if $\li c_1$ and $\li c_2$ are quasi-right-representable, then so
  is $\li (c_1 \times c_2)$.

  % Let $\rho^L_{c_1}$ be a left-representation structure for $c_1$, and
  % let $\rho^L_{c_2}$ be a left-representation structure for $c_2$.
  % Then we can define a left-representation structure for $c_1 \times c_2$.

  % Likewise, let $\rho^R_{Fc_1}$ and $\rho^R_{Fc_2}$ be right-representation
  % structures for $Fc_1$ and $Fc_2$ respectively.
  % Then we can define a right-representation structure for $F(c_1 \times c_2)$.
\end{lemma}
\begin{proof}
  To show $c_1 \times c_2$ is quasi-left-representable, we define
  \begin{itemize}
    \item $e_{c_1 \times c_2} = e_{c_1} \times e_{c_2}$
    \item $\delre_{c_1 \times c_2} = \inl (\delre_{c_1}) \cdot \inr
    (\delre_{c_2})$ (recall from Section \ref{sec:perturbation-constructions}
    that $M_{A_1' \times A_2'}$ is the coproduct $M_{A_1'} \oplus M_{A_2'}$)
    \item $\delle_{c_1 \times c_2}$ is defined similarly
    \item The $\upl$ square is constructed using the functorial action of
    $\times$ and the corresponding squares for $c_1$ and $c_2$:
    % https://q.uiver.app/#q=WzAsNixbMCwwLCJBXzEgXFx0aW1lcyBBXzIiXSxbMCwxLCJBXzEnIFxcdGltZXMgQV8yIl0sWzAsMiwiQV8xJyBcXHRpbWVzIEFfMiciXSxbMSwwLCJBXzEnIFxcdGltZXMgQV8yJyJdLFsxLDEsIkFfMScgXFx0aW1lcyBBXzInIl0sWzEsMiwiQV8xJyBcXHRpbWVzIEFfMiciXSxbMCwzLCJjXzEgXFx0aW1lcyBjXzIiLDAseyJzdHlsZSI6eyJib2R5Ijp7Im5hbWUiOiJiYXJyZWQifSwiaGVhZCI6eyJuYW1lIjoibm9uZSJ9fX1dLFsxLDQsInIoQV8xJykgXFx0aW1lcyBjXzIiLDAseyJzdHlsZSI6eyJib2R5Ijp7Im5hbWUiOiJiYXJyZWQifSwiaGVhZCI6eyJuYW1lIjoibm9uZSJ9fX1dLFsyLDUsInIoQV8xJykgXFx0aW1lcyByKEFfMicpIiwyLHsic3R5bGUiOnsiYm9keSI6eyJuYW1lIjoiYmFycmVkIn0sImhlYWQiOnsibmFtZSI6Im5vbmUifX19XSxbMCwxLCJlX3tjXzF9IFxcdGltZXMgXFxpZCIsMl0sWzEsMiwiXFxpZCBcXHRpbWVzIGVfe2NfMn0iLDJdLFszLDQsImlfe0FfMSd9KFxcZGVscmVfe2NfMX0pIFxcdGltZXMgXFxpZCJdLFs0LDUsIlxcaWQgXFx0aW1lcyBpX3tBXzInfShcXGRlbHJlX3tjXzJ9KSJdLFs5LDExLCJcXHVwbF97Y18xfSBcXHRpbWVzIFxcaWQiLDEseyJzaG9ydGVuIjp7InNvdXJjZSI6MjAsInRhcmdldCI6MjB9LCJzdHlsZSI6eyJib2R5Ijp7Im5hbWUiOiJub25lIn0sImhlYWQiOnsibmFtZSI6Im5vbmUifX19XSxbMTAsMTIsIlxcaWQgXFx0aW1lcyBcXHVwbF97Y18yfSIsMSx7InNob3J0ZW4iOnsic291cmNlIjoyMCwidGFyZ2V0IjoyMH0sInN0eWxlIjp7ImJvZHkiOnsibmFtZSI6Im5vbmUifSwiaGVhZCI6eyJuYW1lIjoibm9uZSJ9fX1dXQ==
      \[\begin{tikzcd}[ampersand replacement=\&]
        {A_1 \times A_2} \& {A_1' \times A_2'} \\
        {A_1' \times A_2} \& {A_1' \times A_2'} \\
        {A_1' \times A_2'} \& {A_1' \times A_2'}
        \arrow["{c_1 \times c_2}", "\shortmid"{marking}, no head, from=1-1, to=1-2]
        \arrow[""{name=0, anchor=center, inner sep=0}, "{e_{c_1} \times \id}"', from=1-1, to=2-1]
        \arrow[""{name=1, anchor=center, inner sep=0}, "{i_{A_1'}(\delre_{c_1}) \times \id}", from=1-2, to=2-2]
        \arrow["{r(A_1') \times c_2}", "\shortmid"{marking}, no head, from=2-1, to=2-2]
        \arrow[""{name=2, anchor=center, inner sep=0}, "{\id \times e_{c_2}}"', from=2-1, to=3-1]
        \arrow[""{name=3, anchor=center, inner sep=0}, "{\id \times i_{A_2'}(\delre_{c_2})}", from=2-2, to=3-2]
        \arrow["{r(A_1') \times r(A_2')}"', "\shortmid"{marking}, no head, from=3-1, to=3-2]
        \arrow["{\upl_{c_1} \times \id}"{description}, draw=none, from=0, to=1]
        \arrow["{\id \times \upl_{c_2}}"{description}, draw=none, from=2, to=3]
      \end{tikzcd}\]
    \item The $\upr$ square is defined similarly
  \end{itemize}

  To show that $\li(c_1 \times c_2)$ is quasi-right-representable, we define
  \begin{itemize}
    \item $p_{\li (c_1 \times c_2)} = (p_{\li c_1} \timesk A_2) \circ (A_1' \timesk p_{\li c_2})$
    \item $\dellp_{\li (c_1 \times c_2)} = (\dellp_{\li c_1} \timesk \id) \cdot (\id \timesk \dellp_{\li c_2})$ 
    using the Kleisli product action on syntactic perturbations in Definition \ref{def:kleisli-product-perturbations}
    \item $\delrp_{\li (c_1 \times c_2)} = (\delrp_{\li c_1} \timesk \id) \cdot (\id \timesk \delrp_{\li c_2})$
    \item The squares are obtained via the functorial action of $\timesk$ on the squares for $\li c_1$ and $\li c_2$.
  \end{itemize}
\end{proof}


\eric{Left off here}

%%%%%%%%%
% Arrow %
%%%%%%%%%
\begin{lemma}\label{lem:representation-arrow}
  Let $c : A \rel A'$ and $d : B \rel B'$.
  %
  If $c$ is quasi-left-representable and $d$ is quasi-right-representable, then
  $c \arr d$ is quasi-right-representable.

  Likewise, if $\li c$ is quasi-right-representable and $Ud$ is
  quasi-left-representable, then $U(c \arr d)$ is quasi-left-representable.

  % Let $\rho^L_c$ be a left-representation structure for $c$,
  % and let $\rho^R_d$ be a right-representation structure for $d$.
  % Then we can define a right-representation structure for $c \arr d$.

  % Likewise, let $\rho^R_{Fc}$ be a right-representation structure for $Fc$,
  % and let $\rho^L_{Ud}$ be a left-representation structure for $Ud$.
  % Then we can define a left-representation structure for $U(c \arr d)$.
\end{lemma}
\begin{proof}
  To show $c \arr d$ is quasi-right-representable, we define:
  \begin{itemize}
    \item $p_{c \arr d} = e_c \arr p_d$
    \item $\dellp_{c \arr d} = \inl(\delle_c) \cdot \inr(\dellp_d)$
    \item $\delrp_{c \arr d} = \inl(\delre_c) \cdot \inr(\delrp_d)$
    \item The squares $\dnr$ and $\dnl$ are obtained via the functorial action of $\arr$, i.e., we define
    
    \[ \dnr_{c \arr d} = \upr_{c} \arr \dnr_{d} : 
      (\delle_c \arr \dellp_d) \ltdyn_{r(A \arr B)}^{c \arr d} (e_c \arr p_d),  \]
    
    and

    \[ \dnl_{c \arr d} = \upl_{c} \arr \dnl_{d}. \]
    
  \end{itemize}

  % TODO check this
  We define $\rho^L_{U(c \arr d)}$ as follows:
  \begin{itemize}
    \item $e_{U(c \arr d)} = (p_{Fc} \tok B') \circ (A \tok e_{Ud})$
    \item $\delre_{U(c \arr d)} = (\delrp_{Fc} \tok B') \circ (A' \tok \delre_{Ud})$
    \item $\delle_{U(c \arr d)} = (\dellp_{Fc} \tok B) \circ (A \tok \delle_{Ud})$
    \item The squares $\upl$ and $\upr$ are obtained via the functorial action of $\tok$.
    For instance, $\upl$ is given by the following square:

    % https://q.uiver.app/#q=WzAsNixbMCwwLCJVKEEgXFx0byBCKSJdLFsyLDAsIlUoQScgXFx0byBCJykiXSxbMiwxLCJVKEEnIFxcdG8gQicpIl0sWzIsMiwiVShBJyBcXHRvIEInKSJdLFswLDEsIlUoQSBcXHRvIEInKSJdLFswLDIsIlUoQScgXFx0byBCJykiXSxbMCwxLCJVKGMgXFx0byBkKSJdLFs0LDIsIlUoYyBcXHRvIHIoQicpKSJdLFs1LDMsIlUocihBJykgXFx0byByKEInKSkiXSxbNCw1LCJwX3tGY30gXFx0b2sgQiciLDJdLFsxLDIsIkEnIFxcdG9rIFxcZGVscmVfe1VkfSJdLFsyLDMsIlxcZGVscnBfe0ZjfSBcXHRvayBCJyJdLFswLDQsIkEgXFx0b2sgZV97VWR9IiwyXSxbMTIsMTAsIlxcaWRfe0ZjfSBcXHRvayBcXHVwbF97VWR9IiwxLHsic2hvcnRlbiI6eyJzb3VyY2UiOjIwLCJ0YXJnZXQiOjIwfSwic3R5bGUiOnsiYm9keSI6eyJuYW1lIjoibm9uZSJ9LCJoZWFkIjp7Im5hbWUiOiJub25lIn19fV0sWzksMTEsIlxcZG5sX3tGY30gXFx0b2sgXFxpZF97cihCJyl9IiwxLHsic2hvcnRlbiI6eyJzb3VyY2UiOjIwLCJ0YXJnZXQiOjIwfSwic3R5bGUiOnsiYm9keSI6eyJuYW1lIjoibm9uZSJ9LCJoZWFkIjp7Im5hbWUiOiJub25lIn19fV1d
    \[\begin{tikzcd}[ampersand replacement=\&,row sep=large]
      {U(A \to B)} \&\& {U(A' \to B')} \\
      {U(A \to B')} \&\& {U(A' \to B')} \\
      {U(A' \to B')} \&\& {U(A' \to B')}
      \arrow["{U(c \to d)}", from=1-1, to=1-3]
      \arrow["{U(c \to r(B'))}", from=2-1, to=2-3]
      \arrow["{U(r(A') \to r(B'))}", from=3-1, to=3-3]
      \arrow[""{name=0, anchor=center, inner sep=0}, "{p_{Fc} \tok B'}"', from=2-1, to=3-1]
      \arrow[""{name=1, anchor=center, inner sep=0}, "{A' \tok \delre_{Ud}}", from=1-3, to=2-3]
      \arrow[""{name=2, anchor=center, inner sep=0}, "{\delrp_{Fc} \tok B'}", from=2-3, to=3-3]
      \arrow[""{name=3, anchor=center, inner sep=0}, "{A \tok e_{Ud}}"', from=1-1, to=2-1]
      \arrow["{\id_{Fc} \tok \upl_{Ud}}"{description}, draw=none, from=3, to=1]
      \arrow["{\dnl_{Fc} \tok \id_{r(B')}}"{description}, draw=none, from=0, to=2]
    \end{tikzcd}\]
  \end{itemize}

  The construction of $\upr$ is similar.
\end{proof}



% We can now show that our notions of value and computation relations compose,
% which follows from the preceding lemmas.


% We now establish the quasi-order-equivalence for the functors.
% We already showed that $U(d \comp d') \qordeq U(d)U(d')$ and $F(c \comp c'') \qordeq F(c)F(c')$
% in the proof of Lemma \ref{lem:representation-comp}.
% The other two properties
% $(cc') \to (dd') \qordeq (c \to d)(c' \to d')$ and
% $(c_1c_1') \times (c_2c_2') \qordeq (c_1 \times c_2)(c_1'\times c_2')$
% are proved similarly, noting in both cases that the both relations are
% quasi-represented by the same morphism.





% %%%%%%%%%%%%%%%%%%%%%%
% % Model Construction %
% %%%%%%%%%%%%%%%%%%%%%%
% Now we can give the proof of the main lemma:
%   % Write 
%   % %
%   % \[ \mathcal M = (\vf, \vsq, \ef, \esq, \Ff, \Fsq, \Uf, \Usq, \arrf, \arrsq). \] 
%   % %

%   We define a step-3 model $\mathcal M'$ as follows:
%   \begin{itemize}
%     \item The objects of $\mathcal M'$ are defined to be the same as the objects of $\mathcal M$.
%     \item The value and computation morphisms in $\mathcal M'$ are the same as those of $\mathcal M$.
%     \item A value relation is defined to be a tuple $(c, \rho^L_c, \rho^R_{Fc})$ with
%     \begin{itemize}
%       \item $c$ a value relation in $\mathcal M$,
%       \item $\rho^L_c$ a left-representation structure for $c$, and
%       \item $\rho^R_{Fc}$ a right-representation structure for $Fc$
%     \end{itemize}
%     \item Likewise, a computation relation is defined to be a tuple $(d, \rho^R_d, \rho^L_{Ud})$ with
%     \begin{itemize}
%       \item $d$ a computation relation in $\mathcal M$,
%       \item $\rho^R_d$ a right-representation structure for $d$, and
%       \item $\rho^L_{Ud}$ a left-representation structure for $Ud$.
%     \end{itemize}
%     \item Morphisms of value relations (i.e., the value squares) are defined by simply
%     ignoring the representation structures. That is, a morphism of value relations
%     $\alpha \in \vsq'((c, \rho^L_c, \rho^R_{Fc}), (c' \rho^L_{c'}, \rho^R_{Fc'}))$ is simply a morphism of value
%     relations in $\vsq(c, c')$. Likewise for computations.
%   \end{itemize}

% We define horizontal composition of relations and squares as follows:
% Let $c : A \rel A'$ and $c' : A' \rel A''$. We define
% %
% \begin{align*} 
%   ((c, \rho^L_c, &\rho^R_{Fc}) \comp (c', \rho^L_{c'}, \rho^R_{Fc'})) =
%   (c \comp c', \rho^L_{c \comp c'}, \rho^R_{F(c \comp c')}), 
% \end{align*}
% %
% and
% %
% \begin{align*}
%   ((d, \rho^R_d, &\rho^L_{Ud}) \comp (d', \rho^R_{d'}, \rho^L_{Ud'})) =
%   (d \comp d', \rho^R_{d \comp d'}, \rho^L_{U(d \comp d')}),
% \end{align*}
% %
% where $\rho^L_{c \comp c'}, \rho^R_{F(c \comp c')}, \rho^R_{d \comp d'},$
% and $\rho^L_{U(d \comp d')}$ are as defined in Lemma \ref{lem:representation-comp}.

% Now we define the functors $F$, $U$, $\times$, and $\arr$.
% On objects, the behavior is the same as the respective functors in $\mathcal M$.
% For relations, we define

% \[ F(c, \rho^L_c, \rho^R_{Fc}) = 
%   (F c, \rho^R_{Fc}, \rho^L_{UF(c)}), \]
% and
% \[ U(d, \rho^R_d, \rho^L_{Ud}) = 
%   (U d, \rho^L_{Ud}, \rho^R_{FU(d)}), \]

% where $\rho^L_{UF(c)}$ and $\rho^R_{FU(d)}$ are as defined in the proof of Lemma
% \ref{lem:representation-UF-FU}.

% We define \[ (c_1, \rho^L_{c_1}, \rho^R_{Fc_1}) \times (c_2, \rho^L_{c_2}, \rho^R_{Fc_2}) = 
%              (c_1 \times c_2, \rho^L_{c_1 \times c_2}, \rho^R_{F(c_1 \times c_2)}), \]

% where $\rho^L_{c_1 \times c_2}$ and $\rho^R_{F(c_1 \times c_2)}$ are as defined in the
% proof of Lemma \ref{lem:representation-product}.

% Lastly, we define

% \[ (c, \rho^L_c, \rho^R_{Fc}) \arr (d, \rho^R_d, \rho^L_{Ud}) =
%     (c \arr d, \rho^R_{c \arr d}, \rho^L_{U(c \arr d)}), \]

% where $\rho^R_{c \arr d}$ and $\rho^L_{U(c \arr d)}$ are as defined in the proof
% of Lemma \ref{lem:representation-arrow}.

% % We define $(c, \rho^L_c) \arr (d, \rho^R_d) = (c \arr d, \rho^R_{c \arr d})$.




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

